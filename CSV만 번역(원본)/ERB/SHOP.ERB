;SHOP.ERBは完全に各関数を呼び出すエントランス化
;元の処理はSHOP2.ERB及びITEM.ERBに移動
;今후は頻繁にいじる必要が無くなるはず
@EVENTSHOP
#PRI
DRAWLINE

@SHOW_SHOP
CALL VERSION_UP

;アイテム購入処理用
SIF TFLAG:0 > 0
	TFLAG:0 = 0
IF TFLAG:0 == 0
	DRAWLINE
	REPEAT 200
		ITEMSALES:COUNT = 0
	REND
	DRAWLINE
	;ミッション時に表示
	IF FLAG:5 == 8
		PRINTFORM FREE MISSION {FLAG:24}　
	ENDIF
	PRINTV DAY
	PRINT 日目
	;昼
	IF TIME == 0
		SETCOLOR 0xDBA901
			PRINTFORM 昼
		RESETCOLOR
	ELSE
		SETCOLOR 0x8080ff
			PRINTFORM 夜
		RESETCOLOR
	ENDIF

	;カレンダーをランダムに作成します
	IF FLAG:80 == 0
		D = RAND:12
		FLAG:80 = D + 1
		D = RAND:31
		SIF FLAG:80 == 2
			D = RAND:28
		SIF FLAG:80 == 4 || FLAG:80 == 6 || FLAG:80 == 9 || FLAG:80 == 11
			D = RAND:30
		FLAG:81 = D + 1
		D = RAND:3
		FLAG:83 = D
	ENDIF
	;月齢と仮想年号取得してみる
	CALL LUNAR_AGE
	;閏年用
	D = FLAG:83 % 4
	IF (FLAG:80 == 2 && FLAG:81 == 29 && D != 0) || (FLAG:80 == 2 && FLAG:81 == 30 && D == 0) || ((FLAG:80 == 4 || FLAG:80 == 6 || FLAG:80 == 9 || FLAG:80 == 11) && FLAG:81 == 31) || FLAG:81 == 32
		FLAG:81 = 1
		FLAG:80 += 1
		SIF FLAG:80 == 13
			FLAG:80 = 1
		;月齢計算でついでに仮想年号も取得しているのでプラス
		SIF FLAG:80 == 1 && FLAG:81 == 1
			FLAG:83 += 1
	ENDIF
	SIF FLAG:82 == 7
		FLAG:82 = 0

	PRINTFORM 　{FLAG:80}月{FLAG:81}日
	SIF FLAG:82 == 0
		PRINT (日)
	SIF FLAG:82 == 1
		PRINT (月)
	SIF FLAG:82 == 2
		PRINT (火)
	SIF FLAG:82 == 3
		PRINT (水)
	SIF FLAG:82 == 4
		PRINT (木)
	SIF FLAG:82 == 5
		PRINT (金)
	SIF FLAG:82 == 6
		PRINT (土)
	PRINTFORML 　(所持甲州金{MONEY}고슈금)
	LOCALS = %CALLNAME:MASTER%(主人)
	PRINTFORML %LOCALS,20,LEFT%
	MAXBASE:MASTER:사정 = 10000
	IF ASSI >= 0
		LOCALS = %CALLNAME:ASSI%(助손)
		PRINTFORML %LOCALS,20,LEFT%
		MAXBASE:ASSI:사정 = 10000
	ENDIF
	IF TARGET > 0
		LOCALS = %CALLNAME%(調教中)
		PRINTFORM %LOCALS,20,LEFT%
		CALL PRINT_BASE_SHOP(TARGET)
		MAXBASE:사정 = 15000
	ENDIF
	SETCOLOR 140,140,140
	DRAWLINE
	RESETCOLOR
	CALL STATUS
	
	;現助손＋元助손のキャラ数の確認
	S = 0
	T = 0
	REPEAT CHARANUM
		;育児部屋に移動しているキャラは除外
		C = COUNT
		CALL CHECK_CHILD_CARE
		SIF RESULT == 1
			CONTINUE
		SIF CFLAG:COUNT:1 > 1
			S += 1
		SIF CFLAG:COUNT:1 == 1 || CFLAG:COUNT:1 == 2
			T += 1
	REND
	;TIMEに合った調教キャラが居るか
	E = 0
	REPEAT CHARANUM
		;主人と奴隷と労役中のキャラは排除
		SIF COUNT == MASTER
			CONTINUE
		SIF COUNT == TARGET
			CONTINUE
		;共犯者、マスターは排除
		SIF CFLAG:COUNT:1 > 2
			CONTINUE
		SIF CFLAG:COUNT:12 > 0
			CONTINUE
		;育児部屋に移動しているキャラは除外
		C = COUNT
		CALL CHECK_CHILD_CARE
		SIF RESULT == 1
			CONTINUE
		E += 1
	REND
	SETCOLOR 140,140,140
	IF FLAG:5 == 8
		CALL FREE_MISSION_CONFIRM
	ELSEIF !FLAG:5
		PRINTFORML 目標：100日以内に甲州金1000000고슈금稼ぎ、[納金]せよ
	ENDIF
	CALL SHOW_TIPS
	RESETCOLOR
	SETCOLOR 140,140,140
	DRAWLINE
	RESETCOLOR
	LOCAL:1 = 0
	FOR LOCAL, 0, 23
		LOCALS = 
		SELECTCASE LOCAL
			CASE 0
				SIF TARGET >= 0
					LOCALS = [200] 調教
			CASE 1
				SIF CHARANUM > 0
					LOCALS = [210] 刀帳
			CASE 2
				LOCALS = [220] 休憩
			CASE 3
				SIF CHARANUM < 800 && (FLAG:5 == 0 || FLAG:5 == 9)
					LOCALS = [300] 奴隷購入
			CASE 4
				LOCALS = [310] 万屋
			;CASE 5
			;	LOCALS = [320] ブティック
			;CASE 6
			;	LOCALS = [330] 薬店
			;CASE 7
			;	LOCALS = [340] 秘密ショップ
			CASE 8
				LOCALS = [400] 労役指示
			CASE 9
				LOCALS = [450] 労役指示(本丸)
			CASE 10
				SIF E >= 1
					LOCALS = [500] 調教対象変更
			CASE 11
				SIF S >= 1
					LOCALS = [510] 主人の変更
			CASE 12
				SIF S >= 1
					LOCALS = [520] 助손の変更
			CASE 13
				LOCALS = [550] 能力上昇
			CASE 14
				LOCALS = [600] コンフィグ
			CASE 15
				LOCALS = [610] キャラコンフィグ
			CASE 16
				LOCALS = [700] ヘルプ
			;CASE 17
			;	LOCALS = [710] キャラ図鑑
			;CASE 18
			;	LOCALS = [777] デバッグメニュー
			CASE 19
				LOCALS = [800] セーブ
			CASE 20
				LOCALS = [900] ロード
			CASE 21
				SIF MONEY >= 1000000 && FLAG:5 == 0 && CFLAG:MASTER:1 == 3
					LOCALS = [910] 納金
			CASE 22
				SIF FLAG:40 == 10
					LOCALS = [920] 強くてニューゲーム
		ENDSELECT
		IF STRLENS(LOCALS)
			PRINTFORM %LOCALS,26,LEFT%
			LOCAL:1++
			SIF (LOCAL:1 % 3) == 0
				PRINTL 
		ENDIF
	NEXT
ENDIF
IF TFLAG:0 < 0
	SIF TFLAG:0 == -2
		CALL SHOP_ITEM_LIST(TFLAG:1)
	PRINTBUTTON "[999]戻る　　　", 999
	PRINTL 
ENDIF

@USERSHOP
SIF TFLAG:0 == 0
	TFLAG:1 = 0
;調教
IF RESULT == 200 && TARGET >= 0
	BEGIN TRAIN
	RETURN 1
;刀帳
ELSEIF RESULT == 210 && CHARANUM > 0
	CALL SHOW_CHARADATA
;休憩（日常イベント）
ELSEIF RESULT == 220
	;休憩フラグを立てる（ここは特別）
	FLAG:0 = 2
	CALL DAILY_LIFE
	BEGIN TURNEND
	RETURN 1
;奴隷購入
ELSEIF RESULT == 300 && CHARANUM < 800 && (FLAG:5 == 0 || FLAG:5 == 9) && TFLAG:0 == 0
	K = 0
	CALL CHARA_BUY
;万屋
ELSEIF RESULT == 310
	TFLAG:1 = 1
;ELSEIF RESULT == 320
;	TFLAG:1 = 1
;ELSEIF RESULT == 330
;	TFLAG:1 = 1
;ELSEIF RESULT == 340
;	TFLAG:1 = 1
;労役指示
ELSEIF RESULT == 400 && TFLAG:0 == 0
	CALL CHARA_WORKING
;労役指示(本丸)
ELSEIF RESULT == 450 && TFLAG:0 == 0
	CALL CHARA_WORKING_HONMARU
;調教対象変更
ELSEIF RESULT == 500 && E >= 1 && TFLAG:0 == 0
	CALL CHANGE_TARGET
;主人の変更　調教者変更機能拡張
ELSEIF RESULT == 510 && S >= 1 && TFLAG:0 == 0
	CALL SELECT_MASTER
;助손の変更
ELSEIF RESULT == 520 && S >= 1 && TFLAG:0 == 0
	CALL SELECT_ASSI
;能力上昇
ELSEIF RESULT == 550
	CALL SHOP_ABLUP(TARGET)
;コンフィグ
ELSEIF RESULT == 600 && TFLAG:0 == 0
	CALL OPTION
;キャラコンフィグ
ELSEIF RESULT == 610 && TFLAG:0 == 0
	CALL OPTION_CHARA
;ヘルプ
ELSEIF RESULT == 700
	CALL DICTIONARY_MENU
;キャラ図鑑
ELSEIF RESULT == 710
	CALL CHARA_DICTIONARY_MENU
;デバッグメニュー
ELSEIF RESULT == 777
	CALL DEBUG_MENU_SHOP
;セーブ
ELSEIF RESULT == 800 && TFLAG:0 == 0
	SAVEGAME
;ロード
ELSEIF RESULT == 900 && TFLAG:0 == 0
	LOADGAME
;エンディング処理
ELSEIF RESULT == 910 && MONEY >= 1000000 && FLAG:5 == 0 && FLAG:23 <= 0 && TFLAG:0 == 0 && CFLAG:MASTER:1 == 3
	CALL ENDING_CHECK
;強くてニューゲーム
ELSEIF RESULT == 920 && FLAG:40 == 10
	CALL TSUYOKUTE_GAME

ELSEIF RESULT == 930 && TFLAG:0 != 0
	TFLAG:0 = 0
ELSEIF RESULT == 999
	TFLAG:0 = 0
	RETURN 0
ENDIF
SIF TFLAG:1 == 0
	RETURN 0
CALL SHOP_ITEM_LIST(TFLAG:1)
;-------------------------------------------------------
;TIPS
;-------------------------------------------------------
@SHOW_TIPS
VARSET LOCAL
SIF !FLAG:154
	RETURN 0
LOCALS = 
SETCOLOR 0x8888FF

FOR LOCAL, 0, CHARANUM
	SIF LOCAL == MASTER
		CONTINUE
	SIF 10 * BASE:LOCAL:체력 / MAXBASE:LOCAL:체력 < 8
		LOCAL:1++
	SIF CFLAG:LOCAL:1 == 3
		LOCAL:2++
	SIF CFLAG:LOCAL:1 >= 2
		LOCAL:3++
	SIF CFLAG:LOCAL:1 >= 1
		LOCAL:4++
	SIF KANRAKU2(LOCAL) == 1
		LOCAL:5++
	SIF KANRAKU2(LOCAL) == 2
		LOCAL:6++
	SIF KANRAKU2(LOCAL) == 3
		LOCAL:7++
	SIF CFLAG:LOCAL:1 < 3
		LOCAL:8++
	LOCAL:9++
NEXT

IF !GETBIT(FLAG:154,1) && CHARANUM > 0
	LOCALS = [210] 刀帳から、キャラクターの素質や能力を見ることが出来ます。
	SETBIT FLAG:154, 1
ENDIF
IF !GETBIT(FLAG:154,2) && TARGET >= 0 && LOCALS == ""
	LOCALS = [200] 調教を開始し、目標の達成を目指しましょう。
	SETBIT FLAG:154, 2
ENDIF
IF !GETBIT(FLAG:154,3) && !LOCAL:9 && LOCALS == ""
	LOCALS = [300] まずは奴隷を購入してみましょう。
	SETBIT FLAG:154, 3
ENDIF
IF !GETBIT(FLAG:154,4) && MONEY >= 1000000 && !FLAG:5 && FLAG:23 <= 0 && !TFLAG:0 && CFLAG:MASTER:1 == 3 && LOCALS == ""
	LOCALS = [910] 資金が貯まりました！[納金]すればエンディングです。
	SETBIT FLAG:154, 4
ENDIF
IF !GETBIT(FLAG:154,5) && FLAG:40 == 10 && LOCALS == ""
	LOCALS = [920] さあ、有利なボーナスを得て次の周回を開始しましょう。
	SETBIT FLAG:154, 5
ENDIF
IF !GETBIT(FLAG:154,6) && MONEY >= 1000000 && !FLAG:5 && FLAG:23 <= 0 && !TFLAG:0 && CFLAG:MASTER:1 < 3 && LOCALS == ""
	LOCALS = 元々の主人公か共犯者でないと[納金]できません。
	SETBIT FLAG:154, 6
ENDIF
IF !GETBIT(FLAG:154,7) && LOCAL:1 && LOCALS == ""
	LOCALS = [220] 休憩を取ることで、自動的に刀剣の손入れが行われます。
	SETBIT FLAG:154, 7
ENDIF
IF !GETBIT(FLAG:154,8) && TARGET > -1 && JUEL:부정 >= 100 && LOCALS == ""
	LOCALS = 無理な調教は부정を募らせ、반발を生んでしまいます。
	SETBIT FLAG:154, 8
ENDIF
IF !GETBIT(FLAG:154,9) && LOCAL:2 && LOCALS == ""
	LOCALS = [510] たまには共犯者に調教を任せてみるのもいいかもしれません。
	SETBIT FLAG:154, 9
ENDIF
IF !GETBIT(FLAG:154,10) && LOCAL:3 && LOCALS == ""
	LOCALS = [520] 調教に助손をつれていくと、新たなコマンドが使えるかもしれません。
	SETBIT FLAG:154, 10
ENDIF
IF !GETBIT(FLAG:154,11) && LOCAL:8 > 1 && LOCALS == ""
	LOCALS = [500] 他の奴隷を調教したいなら、調教対象変更を選びましょう。
	SETBIT FLAG:154, 11
ENDIF
IF !GETBIT(FLAG:154,12) && ITEM:비디오카메라 && !ITEM:비디오테이프 && LOCALS == ""
	LOCALS = [310] 비디오테이프を購入して撮影すれば、ＡＶを売って資金を得ることができます。
	SETBIT FLAG:154, 12
ENDIF
IF !GETBIT(FLAG:154,13) && !LOCAL:4 && LOCAL && MONEY <= 1000 && ((FLAG:4 == 1 && DAY >= 20) || (FLAG:4 == 2 && DAY >= 15) || (FLAG:4 == 3 && DAY >= 10)) && LOCALS == ""
	LOCALS = [400] どうしようも無くなったら、奴隷を捨て値で売ってしまうのも一손です。
	SETBIT FLAG:154, 13
ENDIF
IF !GETBIT(FLAG:154,14) && LOCAL:4 && LOCALS == ""
	LOCALS = [400] 奴隷を[売却]すれば、まとまった資金が得られます。
	SETBIT FLAG:154, 14
ENDIF
IF !GETBIT(FLAG:154,15) && (LOCAL:5 + LOCAL:6 + LOCAL:7) > 0 && LOCALS == ""
	LOCALS = [400] %CALLNAME%を働かせて資金を得ることができます。
	SETBIT FLAG:154, 15
ENDIF
IF !GETBIT(FLAG:154,16) && LOCAL:5 && LOCALS == ""
	LOCALS = [400] 포장마차や雷舞は、しっかり下積みさせるのが儲けるコツです。
	SETBIT FLAG:154, 16
ENDIF
IF LOCALS == ""
	IF !RAND:8
		LOCALS = %CALLNAME:MASTER%の기교が上がれば、より調教は容易になるでしょう。
	ELSEIF !RAND:7
		LOCALS = コマンドフィルタから、必要ないコマンドを消すことができます。
	ELSEIF !RAND:6
		LOCALS = 기력が０になると、調教効率が格段に落ちてしまいます。
	ELSEIF !RAND:5
		LOCALS = [220] 休憩から、みんなの普段の姿がみられます。
	ELSEIF !RAND:4
		LOCALS = [700] ヘルプからeraToLoveの用語解説、攻略のヒントが見られます。
	ELSEIF !RAND:3
		LOCALS = [310] 新たな道具を得れば、調教の効率が良くなるでしょう。
	ELSEIF RAND:2
		LOCALS = [310] 薬の使い過ぎは精神に深刻なダメージを与えます。
	ELSE
		LOCALS = [310] 調教に有利な技能など、通常は買えないものが置いてあります。
	ENDIF
ENDIF

SIF LOCALS != ""
	PRINTFORML ＜Tips: %LOCALS%＞
RESETCOLOR

