ギルベルトさんとエリザベータさんによる今回のバグ解説


-------------------------------------------------------------------------------
【前置き】
-------------------------------------------------------------------------------

343 ：名無しも飲み物：2009/12/25(金) 02:03:56 ID:4Jzx6JeQ
普口上で奴隷と助手が一緒に逃亡するイベントを作っていたのですが、
詰まってしまったので質問させてください

奴隷と助手を削除して調教を終了させようと、簡易助手口上の二回目以降に
	DELCHARA TARGET
	DELCHARA ASSI
	NEXTCOM = 999
	RETURN 0
と入れたところ、
	EVENT_K5_ALL.ERBの38行目でエラーが発生しました
	SIF NO:TARGET != 5
	キャラクタ配列変数NOの第１引数(6)はキャラ登録番号の範囲外です
と表示され強制終了されました
なぜ日口上のエラーになるのでしょうか… 



『解説が物凄く長くなるから先にエラーの解決法だけ載せておくわね。
　これは調教開始前の口上でいきなり調教対象を削除してるから起きたエラーなの』
「じゃあ奴隷と助手が逃亡するイベントは作れねえのか？」
『作れるわよ。まず、助手の削除はここでやっちゃって構わないわ。
　奴隷の方はへたくしょんの@NEXTCOM999関数に奴隷の削除機能が付いてるから、
　そっちの方で削除すればエラー落ちしなくて済むの』
「TFLAG:400 = 1にすれば良いんだったな」
『そうそう。で、このまま削除すると登録番号がスライドしちゃって
　「助手可能じゃないキャラが助手になってる」バグがついでに発生しちゃうから、
　それを防止するためにNEXTCOM宣言の前にASSI = -1も書き足しておいて。
　だから、エラーが起きないようにするには――』

	DELCHARA ASSI
	ASSI = -1
	TFLAG:400 = 1
	NEXTCOM = 999
	RETURN 0

『これでほぼ想定してる内容のイベントを作れるはずよ。
　以下の内容はまあ、趣味とか好奇心の領域で読んでくれたら嬉しいわね』



-------------------------------------------------------------------------------
【解説】
-------------------------------------------------------------------------------

「で、だ。何で俺様の口上を作ってたのに菊のエラーになってるんだよ？」
『それを解説する前に、イベント関数の話をしてもいい？
　これについて話しておかないとこのエラーの原因を解説できないのよ』
「そういう訳ならしょうがねえな……で？　イベント関数ってのはなんなんだ？」
『その前に、まずは本家eramaker公式サイトのこのページをざっと読んで来て。
　感が良い人ならこれだけでエラーの原因が掴めるかもしれないわね』

http://www.hakagi.com/a.html

『どう？　エラーの原因は理解出来た？』
「いや……言ってる事は解るんだが、エラーの原因には直接結び付かないぜ」
『うん、じゃあ一つ一つ解説していくわ。
　そうそう、この解説ファイルはこのページと二窓しながら見ていくといいわよ』


『解説に入る前に少しだけCALLと関数の動作について説明させてくれる？
　ERBファイルは基本的に上から順番に内容を読み込んでるの。
　で、CALLされたものと同じ関数があったらそれを呼び出してるわ。だから……』

A = RAND:5
CALL era

A.ERB
	@era
	PRINT この関数はダミーです。

B.ERB
	@era
	IF A == 0
		PRINT Aは0です。
	ELSEIF A == 1
		PRINT Aは1です。
	ELSE
		PRINT Aは0でも1でもありません。
	ENDIF

『なんて状況だと、上の方にあるダミー関数が呼ばれちゃうの』
「ああ、だからスレの方で『関数はかぶらないように』って話が出てたんだな」
『そういう事。キャラ番号の問題で、フェリちゃんやロヴィーノ君口上の方が読みこみ優先度が高いでしょ？
　その辺りと関数がかぶっちゃうと最悪エラー落ちしちゃうしね。
　だから、もし口上専用イベントを作るなら関数内にキャラ番号を付けておいたほうがいいわ』
「それがお互いの為になるしな。で、質問いいか」
『何か質問するようなことがあったかしら』
「あるぜ。【基本的に上から順番】って言ったな。例外もあるのか？」
『……アンタ、変なところで目ざといのね。あるわよ例外。それがイベント関数なの』
「じゃあとっとと説明しろよ。俺は早くこのエラーの原因を知りてえんだ」
『解ってるわよ。それじゃ、いよいよイベント関数の話ね。
　イベント関数って言うのは、【特定のタイミングで必ず読みこまれる関数】の事。
　これは実物を見た方が早いかしら、口上テンプレートの一番上にこんな部分があるでしょ？』

;--------------------------------------------------
;口上ファイルの存在判定（X2をキャラ番号に置換）
;--------------------------------------------------
@EVENTSHOP
#PRI
FLAG:1X2 = 1
SIF FLAG:7 == 0
FLAG:7 = 2

;--------------------------------------------------
;EVENTTRAIN関係（X1をキャラ番号に置換）
;調教開始時のセリフ CFLAG 201～219を使用
;--------------------------------------------------
@EVENTTRAIN
SIF FLAG:7 <= 0
	RETURN 0
SIF NO:TARGET != X1
	RETURN 0

「ああ、あるな。これが何なんだ？」
『この@EVENTSHOPと@EVENTTRAINはどちらもイベント関数なの。
　どちらもショップ画面と調教開始前に必ず読みこまれている関数よ】』
「ふーん……ちょっと待て、この関数は口上テンプレートの一番上にあるんだろ？」
『あるわね』
「つまり、フェリシアーノちゃんやそのお兄様、ヴェストの口上ファイルにもこの関数があるって事だ。
　eramakerは上から順番に内容を読んでんだろ？
　だったらフェリシアーノちゃんのファイルでこれを呼び出した瞬間に、
　他の口上ファイルでは呼ばれなくなるんじゃないのか？」
『でも、アンタの口上はちゃんと表示されてるでしょう？』
「されてるぜ」
『それは、このイベント関数が【特定のタイミングで必ず読みこまれる関数】だからよ。
　これだけは何があろうと、存在する分だけ全部呼び出しているの』
　で、さっきのエラーはこれが理由で発生したエラーなのよ』
「存在するだけ絶対に呼び出すから……ああ、俺の口上の次に、菊の口上を読み込む。
　その時に引っかかって菊口上のエラーになったのか」
『そういう事。アンタの口上内で奴隷と助手が削除されちゃってるから、
　NO:TARGETの因数が【既に存在しないキャラ】を呼び出しちゃってエラーになったの。
　だから、調教開始前口上の段階でTARGETを削除するのはお勧めしないわ』
「俺の調教……されるのはゴメンだが、してる時も全員分のを読み込んでるんだな」
『ええ。だからうっかり書き方を間違えると、もちめりかの調教中にアンタの口上を読み込んだりするわよ』
「どうやってそんな間違いを起こすんだよ！？」
『だから間違えないようにSIF NO:TARGET != X1ってIF文があるじゃない。
　これより上に構文書いたら凄い事になるけどね』


『って事で、解説お終い。もしまだ解らない事があったり、
　ここもっと詳しく！　って部分があったらスレの方で声かけて貰えるかしら』
「EVENTCOM系を利用したイベントの作り方とか、解説しようと思えばそれなりにネタあるしな」
『その分結構ややこしいんだけどね』







「ところで、何でエラー解決のためにへたくしょんの方でキャラ削除してるんだ？」
『erahetaAではEVENTCOMの読み込みが全部終わって、
　着衣チェックも全部終わった段階じゃないとキャラ削除でエラー落ちするのよ。
　じゃあ着衣チェックもさせずに強制終了すればいいじゃないか、って話なんだけど
　生憎EVENTCOMからだと直接調教を終了する事が出来ないの』
「八方ふさがりなのか」
『だからもう着衣チェック終わらせてから削除なり強制終了しちゃおうかなって。
　NEXTCOM指定しちゃえば身動きとらせずに調教が進行するから、
　そっちで動かしちゃおうと思った結果がアレらしいわよ』
